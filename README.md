# AI Travel Planner

面向用户体验的旅行规划系统：通过 AI 对话快速收集需求，自动生成可编辑的每日行程、费用预算与地图标记，并支持语音输入与历史管理。前端采用 React + Vite，后端采用 Express，所有能力均围绕“可用即见、可改可存”的功能设计展开。

**界面布局**
- 顶部栏：显示应用标题与当前用户（或体验模式），支持一键退出。
- 左侧边栏：历史行程列表，可选择加载或删除（登录后可保存）。
- 主区域（两列）：左侧为 AI 咨询对话，右侧为行程规划与地图、预算等信息展示。

**核心功能**
- AI 旅行顾问（聊天）
  - 显示对话历史，支持 `Enter` 发送、`Shift+Enter` 换行。
  - 一键“重新开始”对话，让顾问回到欢迎语引导。
  - 根据用户输入自动更新“行程需求”、触发重生成或局部微调，并返回提示与问题列表。
  - 智能调用系统工具：
    - 更新行程（在用户请求调整时优先局部修改），
    - 规划路线（返回距离/时长/关键步骤），
    - 估算预算（生成或重新估算）。

- 行程需求表（生成入口）
  - 目的地、时间范围、预算、同行人数、偏好标签与备注。
  - 语音输入：浏览器 Web Speech（可用自动启用）或后端录音转写模式；识别结果自动写入备注。
  - 一键生成行程，后续可在编辑器中细调。

- 行程概览与编辑器
  - 概览：目的地与时间、每日安排、亮点、住宿推荐、交通建议等结构化展示。
  - 编辑器：支持“基本信息、每日计划、亮点、住宿、交通建议”全面编辑与增删。
  - 地理能力：在编辑亮点时支持地理编码（需配置地图 Key），以便后续地图标注。
  - 保存：在登录状态下可写入服务端以持久化。

- 费用预算
  - 按行程计算总费用与分项（交通、住宿、餐饮、娱乐、机动）。
  - 一键“重新估算”，便于在编辑后刷新成本预期。

- 地图展示
  - 自动根据每日亮点做地点标记，信息窗显示名称与描述。
  - 自适应视野（FitView），一键聚焦到所有标记点。
  - 路线展示：对话中规划出的路线会以结构化列表显示在行程视图中（包含距离、时长、步骤）。

- 历史行程
  - 列表：展示目的地与创建时间；点击加载。
  - 删除：登录状态可删除指定历史记录。
  - 保存：登录用户在右侧编辑器完成后可保存行程。

**使用流程**
- 登录或进入体验模式。
- 在左列聊天中描述旅行想法（语音或文字），系统将逐步追问与完善需求。
- 生成行程后，在右列查看概览，并在编辑器中进行细化或修改。
- 查看预算、地图标注与路线（如需），并根据需要重新估算预算或调整行程。
- 登录状态下保存行程，后续可在侧边栏快速调出。

**交互细节**
- 发送消息：`Enter` 直接发送，`Shift+Enter` 换行。
- 对话重置：点击“重新开始”回到欢迎引导。
- 地图 Key 未配置时：地图面板提示缺失，不影响其他功能。
- 语音模式：优先使用浏览器 Web Speech；不支持时自动切换到后端录音转写。

**配置与降级**
- 配置状态提示：顶部或内容区域显示系统能力可用性（Supabase/LLM/Voice/Map）。
- 降级策略：
  - 无 LLM：返回结构化示例行程，确保前端可完整演示。
  - 无地图 Key：地图面板显示提示，相关编辑器的地理编码禁用。
  - 路线规划失败：前端显示可理解错误信息，不影响其他模块。

**账号与数据**
- 登录与注册：邮箱+密码，成功后显示当前用户；退出后回到登录页或体验模式。
- 历史与保存：登录用户可保存多份行程；体验模式下不保存但可完整试用。

**后端接口（前端实际使用）**
- 配置：`GET /api/config/status`、`GET /api/config/map-key`
- 对话：`POST /api/itineraries/chat/converse`
- 行程：`GET /api/itineraries`、`POST /api/itineraries`、`DELETE /api/itineraries/:id`
- 预算：`POST /api/itineraries/:id/budget`
- 语音：`POST /api/voice/transcribe`
- 认证：`POST /api/auth/login`、`POST /api/auth/register`

**端口与运行**
- 开发：前端 `5173`，后端 `5174`。
- 生产容器：后端监听 `5174`；`SERVE_CLIENT=true` 时同时托管打包后前端资源。

**常见问题**
- 发送键不生效：已支持 `Enter` 发送；若浏览器禁用事件或输入框失焦，请点击输入框后重试。
- 地图不显示：确认服务端环境变量 `AMAP_API_KEY` 已配置，且 `/api/config/map-key` 可返回有效 Key。
- 预算为 0 或分项缺失：行程结构不完整或示例数据触发降级，可在编辑器完善后点击“重新估算”。

**目录结构（概要）**
- `client/`：页面（Auth、Dashboard）、组件（ChatPlanner、ItinerarySummary、BudgetPanel、MapView、ItineraryHistory、VoiceInput）与样式。
- `server/`：路由、控制器与服务（LLM、预算、工具、语音），`/health` 健康检查与错误处理。

如需将文档扩展为“演示脚本”或“运维手册”（例如多用户协作、数据备份、日志规范），可以在此基础上继续补充场景化说明。